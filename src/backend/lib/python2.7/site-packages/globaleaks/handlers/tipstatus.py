# -*- coding: UTF-8
# tipstatus
# ********
#
# Implement the classes handling the requests performed to /tipstatus/* URI PATH
# Used by receivers to update the tip status

from twisted.internet.defer import inlineCallbacks
from storm.expr import And, In

from globaleaks.orm import transact, transact_ro
from globaleaks.handlers.user import db_user_update_user
from globaleaks.handlers.authentication import authenticated, unauthenticated, transport_security_check
from globaleaks.handlers.base import BaseHandler
from globaleaks.handlers.rtip import db_postpone_expiration_date, db_delete_rtip
from globaleaks.handlers.submission import db_get_archived_preview_schema
from globaleaks.handlers.user import user_serialize_user
from globaleaks.models import Receiver, ReceiverTip, TipStatus
from globaleaks.rest import requests, errors
from globaleaks.rest.apicache import GLApiCache
from globaleaks.settings import GLSettings
from globaleaks.utils.structures import Rosetta, get_localized_values
from globaleaks.utils.utility import log, datetime_to_ISO8601


def admin_serialize_tipstatus(tipstatus):
    ret_dict = {}

    ret_dict.update({
        'id': tipstatus.id,
        'description': tipstatus.description,
    })

    return ret_dict


@transact_ro
def get_tipstatus_list(store):
    return [admin_serialize_tipstatus(tipstatus)
            for tipstatus in store.find(TipStatus)]


class TipStatusHandler(BaseHandler):
    """
    This interface return the summary list of the Tips available for the authenticated Receiver
    GET /tipstatus
    """
    @transport_security_check("unauth")
    @unauthenticated
    @inlineCallbacks
    def get(self):
        """
        Response: receiverTipList
        Errors: InvalidAuthentication
        """
        tip_status = yield get_tipstatus_list()

        self.set_status(200)
        self.finish(tip_status)